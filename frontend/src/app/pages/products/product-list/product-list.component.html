<!-- Product List Container -->
<div class="fixed top-0 left-0 w-full h-screen pt-header-height ">
  <p-toast></p-toast>
  
  <div class="h-full flex">
    <!-- Desktop Layout -->
    <div class="hidden lg:flex h-full w-full">
      <ng-container *ngTemplateOutlet="desktopLayout"></ng-container>
    </div>

    <!-- Mobile Layout -->
    <div class="flex lg:hidden h-full w-full flex-column">
      <ng-container *ngTemplateOutlet="mobileLayout"></ng-container>
    </div>
  </div>
  
  <!-- Mobile Filters Drawer -->
  <p-drawer 
    [(visible)]="showMobileFilters"
    position="left"
    styleClass="w-20rem p-0"
    [modal]="true"
    [dismissible]="true"
    [showCloseIcon]="true">
    <ng-template pTemplate="header">
      <span class="font-bold text-xl">{{ 'products.filters.title' | translate }}</span>
    </ng-template>
    <ng-container *ngTemplateOutlet="filtersSidebar"></ng-container>
  </p-drawer>
</div>

<!-- ===================== TEMPLATE DEFINITIONS ===================== -->

<!-- Desktop Layout Template -->
<ng-template #desktopLayout>
  <!-- Sidebar Filter -->
  <aside class="w-22rem m-1 shadow-1 border-round px-2">
    <ng-container *ngTemplateOutlet="filtersSidebar"></ng-container>
  </aside>
  
  <!-- Main Content -->
  <main class="flex-1 flex flex-column min-w-0">
    <ng-container *ngTemplateOutlet="toolbar"></ng-container>
    <ng-container *ngTemplateOutlet="productsArea"></ng-container>
  </main>
</ng-template>

<!-- Mobile Layout Template -->
<ng-template #mobileLayout>
  <ng-container *ngTemplateOutlet="toolbar"></ng-container>
  <ng-container *ngTemplateOutlet="productsArea"></ng-container>
</ng-template>

<!-- Filters Sidebar Template -->
<ng-template #filtersSidebar>
  <app-product-filters
    [categories]="categories()"
    [selectedCategories]="selectedCategories()"
    (categoriesChange)="onCategoriesChange($event)"
    (filtersApplied)="handleFiltersApplied()"
    class="h-full block">
  </app-product-filters>
</ng-template>

<!-- Toolbar Template -->
<ng-template #toolbar>
  <div class="m-1 border-round px-2">
    <app-product-toolbar
      [(searchQuery)]="searchQuery"
      [(viewMode)]="layout"
      [filterCount]="activeFilterCount()"
      (search)="onSearch()"
      (searchInput)="onSearchInput($event)"
      (mobileFiltersToggle)="toggleMobileFilters()"
      (filtersCleared)="clearFilters()">
    </app-product-toolbar>
  </div>
</ng-template>

<!-- Products Area Template -->
<ng-template #productsArea>
  <div class="flex-1 overflow-y-auto p-3">
    <ng-container *ngIf="loading(); else productsContent">
      <app-loading-state></app-loading-state>
    </ng-container>
    
    <ng-template #productsContent>
      <ng-container *ngIf="products().length === 0; else productsList">
        <ng-container *ngTemplateOutlet="emptyState"></ng-container>
      </ng-container>
      
      <ng-template #productsList>
        <ng-container *ngIf="layout() === 'grid'; else listView">
          <ng-container *ngTemplateOutlet="gridView"></ng-container>
        </ng-container>
        
        <ng-template #listView>
          <ng-container *ngTemplateOutlet="listViewTemplate"></ng-container>
        </ng-template>
      </ng-template>
    </ng-template>
  </div>
</ng-template>

<!-- Empty State Template -->
<ng-template #emptyState>
  <app-empty-state
    icon="pi-search"
    [title]="'products.empty.title' | translate"
    [description]="hasActiveFilters() ? ('products.empty.filter_message' | translate) : ('products.empty.subtitle' | translate)"
    [actionLabel]="hasActiveFilters() ? ('products.empty.clear_filters' | translate) : ''"
    [action]="clearFilters.bind(this)">
  </app-empty-state>
</ng-template>

<!-- Grid View Template -->
<ng-template #gridView>
  <div class="grid">
    <div *ngFor="let product of products(); trackBy: trackByProductId" 
         class="col-12 md:col-6 lg:col-4 xl:col-4 xxl:col-3">
      <app-product-card
        [product]="product"
        (addToCartEvent)="onAddToCart($event)"
        class="block h-full">
      </app-product-card>
    </div>
  </div>
</ng-template>

<!-- List View Template -->
<ng-template #listViewTemplate>
  <div class="flex flex-column gap-3">
    <div *ngFor="let product of products(); trackBy: trackByProductId">
      <ng-container *ngTemplateOutlet="productListItem; context: { product: product }"></ng-container>
    </div>
  </div>
</ng-template>

<!-- Product List Item Template -->
<ng-template #productListItem let-product="product">
  <div class="surface-card border-bottom-1 surface-border border-round-0">
    <div class="flex">
      <!-- Product Image - Compact -->
      <div class="relative overflow-hidden w-5rem md:w-10rem h-5rem md:h-8rem flex-shrink-0">
        <a [routerLink]="['/products', product.id]" class="block h-full">
          <img 
            [src]="product.image_url || 'assets/images/product-placeholder.jpg'"
            [alt]="product.name"
            class="w-full h-full"
            class="w-full h-full"
            style="object-fit: cover">
        </a>
        <!-- Overlay badges - matching grid view -->
        <div class="absolute top-0 left-0 w-full p-1 flex justify-content-between align-items-start">
          <div class="flex align-items-start gap-1">
            <ng-container *ngIf="product.is_organic">
              <p-tag 
                severity="success" 
                [value]="'products.tags.organic' | translate" 
                class="shadow-2 text-xs flex-shrink-0"
                icon="pi pi-leaf"
                class="w-auto">
              </p-tag>
            </ng-container>
          </div>
        </div>
      </div>
      
      <!-- Product Content - Compact -->
      <div class="flex-1 p-1 md:px-3 md:py-0 flex flex-column overflow-hidden">
        <!-- Mobile Layout -->
        <div class="block md:hidden px-3 py-2">
          <!-- Product name - Bigger and bolder -->
          <h5 class="text-xl font-medium m-0 mb-2">
            <a [routerLink]="['/products', product.id]" class="text-900 no-underline">
              {{ product.name }}
            </a>
          </h5>
          
          <!-- Description - More readable -->
          <div class="text-sm text-600 mb-3 line-clamp-1 line-height-2 opacity-90">
            {{ product.description || ('products.default_description' | translate) }}
          </div>
          
          <!-- Price and Stock - Cleaner layout -->
          <div class="flex align-items-center justify-content-between mb-3">
            <div class="flex align-items-baseline gap-2">
              <span class="text-base font-semibold text-900">{{ formatPrice(product.price) }}</span>
              <span class="text-sm text-500">{{ getUnitDisplay(product.unit) }}</span>
            </div>
            
            <!-- Stock Status - Better visibility -->
            <div>
              <ng-container *ngIf="isOutOfStock(product)">
                <span class="text-red-500 font-medium text-sm flex align-items-center">
                  <i class="pi pi-times-circle mr-1 text-xs"></i>{{ 'products.stock.out_of_stock' | translate }}
                </span>
              </ng-container>
              <ng-container *ngIf="!isOutOfStock(product) && product.stock_quantity < 20">
                <span class="text-orange-500 font-medium text-sm flex align-items-center">
                  <i class="pi pi-exclamation-circle mr-1 text-xs"></i>{{ product.stock_quantity }} left
                </span>
              </ng-container>
              <ng-container *ngIf="!isOutOfStock(product) && product.stock_quantity >= 20">
                <span class="text-green-500 font-medium text-sm flex align-items-center">
                  <i class="pi pi-check-circle mr-1 text-xs"></i>{{ 'products.stock.in_stock' | translate }}
                </span>
              </ng-container>
            </div>
          </div>
          
          <!-- Quantity selector and add to cart -->
          <ng-container *ngIf="!isOutOfStock(product)">
            <div class="flex flex-column gap-3">
              <div>
                <app-product-quantity-selector
                  [value]="getProductQuantity(product.id)"
                  [unit]="product.unit"
                  [stockQuantity]="product.stock_quantity"
                  [quantityConfig]="product.quantity_config"
                  [pricePerUnit]="product.price"
                  [disabled]="!product.stock_quantity || product.stock_quantity === 0"
                  [showStock]="false"
                  (quantityChanged)="setProductQuantity(product.id, $event)"
                  class="w-full">
                </app-product-quantity-selector>
              </div>
              
              <div class="flex align-items-center gap-2">
                <div class="flex-1">
                  <ng-container *ngIf="isProductInCart(product.id); else notInCartMobile">
                    <span class="text-xs text-green-500">
                      <i class="pi pi-check-circle mr-1 text-sm"></i>
                      {{ getCartQuantity(product.id) }} {{ 'products.cart.in_cart' | translate }} ({{ formatPrice(product.price * getCartQuantity(product.id)) }})
                    </span>
                  </ng-container>
                  <ng-template #notInCartMobile>
                    <span class="text-xs text-500">
                      <i class="pi pi-shopping-cart mr-1 text-xs"></i>
                      {{ 'products.cart.not_in_cart' | translate }}
                    </span>
                  </ng-template>
                </div>
                <!-- Mobile button - icon only with badge -->
                <p-overlayBadge [value]="getProductQuantity(product.id).toString()" severity="success">
                  <button
                    pButton
                    type="button"
                    icon="pi pi-cart-plus"
                    class="p-button-primary p-button-rounded"
                    style="height: 2.5rem; width: 2.5rem;"
                    [disabled]="!product.stock_quantity || product.stock_quantity === 0 || getProductQuantity(product.id) === 0 || getProductQuantity(product.id) > product.stock_quantity"
                    (click)="quickAddToCart(product)">
                  </button>
                </p-overlayBadge>
              </div>
            </div>
          </ng-container>
          
          <!-- Out of stock state -->
          <ng-container *ngIf="isOutOfStock(product)">
            <div>
              <button
                pButton
                [label]="'products.stock.out_of_stock' | translate"
                [disabled]="true"
                class="w-full p-button-secondary"
                class="w-full p-button-secondary border-round-md font-semibold"
                style="height: 2.5rem; font-size: 0.875rem;">
              </button>
            </div>
          </ng-container>
        </div>
        
        <!-- Desktop Layout -->
        <div class="hidden md:block">
          <!-- Header Section -->
          <div class="mb-2">
            <h4 class="text-xl font-medium m-0 mb-1 line-height-1">
              <a [routerLink]="['/products', product.id]" 
                 class="text-900 no-underline hover:text-primary transition-colors transition-duration-200">
                {{ product.name }}
              </a>
            </h4>
            
            <!-- Price and Stock on same line -->
            <div class="flex align-items-center justify-content-between">
              <div class="flex align-items-baseline gap-1">
                <span class="text-base font-semibold text-900">{{ formatPrice(product.price) }}</span>
                <span class="text-xs text-500">/ {{ getUnitDisplay(product.unit) }}</span>
              </div>
              
              <!-- Stock Status - matching grid view style -->
              <div>
                <ng-container *ngIf="isOutOfStock(product)">
                  <span class="text-red-500 font-medium text-sm">
                    <i class="pi pi-times-circle mr-1"></i>{{ 'products.stock.out_of_stock' | translate }}
                  </span>
                </ng-container>
                <ng-container *ngIf="!isOutOfStock(product) && product.stock_quantity < 20">
                  <span class="text-orange-500 font-medium text-sm">
                    <i class="pi pi-exclamation-circle mr-1"></i>{{ 'products.stock.items_left' | translate: {count: product.stock_quantity} }}
                  </span>
                </ng-container>
                <ng-container *ngIf="!isOutOfStock(product) && product.stock_quantity >= 20">
                  <span class="text-green-500 font-medium text-sm">
                    <i class="pi pi-check-circle mr-1"></i>{{ 'products.stock.in_stock' | translate }}
                  </span>
                </ng-container>
              </div>
            </div>
          </div>
          
          <!-- Description -->
          <p class="text-sm text-600 line-height-2 m-0 mb-2 overflow-hidden" style="max-height: 2.5rem;">
            {{ product.description || ('products.default_description' | translate) }}
          </p>
          
          <!-- Quantity Selector and Add to Cart -->
          <div class="mt-auto">
            <ng-container *ngIf="!isOutOfStock(product); else outOfStockButton">
              <div class="flex align-items-center gap-2">
                <app-product-quantity-selector
                  [value]="getProductQuantity(product.id)"
                  [unit]="product.unit"
                  [stockQuantity]="product.stock_quantity"
                  [quantityConfig]="product.quantity_config"
                  [pricePerUnit]="product.price"
                  [disabled]="!product.stock_quantity || product.stock_quantity === 0"
                  [showStock]="false"
                  (quantityChanged)="setProductQuantity(product.id, $event)"
                  class="flex-1">
                </app-product-quantity-selector>
              </div>
              
              <div class="flex align-items-center gap-2 mt-2 py-2">
                <div class="flex-1">
                  <ng-container *ngIf="isProductInCart(product.id); else notInCartDesktop">
                    <span class="text-sm text-green-500">
                      <i class="pi pi-check-circle mr-1 text-sm"></i>
                      {{ getCartQuantity(product.id) }} {{ 'products.cart.in_cart' | translate }} ({{ formatPrice(product.price * getCartQuantity(product.id)) }})
                    </span>
                  </ng-container>
                  <ng-template #notInCartDesktop>
                    <span class="text-sm text-500">
                      <i class="pi pi-shopping-cart mr-1 text-sm"></i>
                      {{ 'products.cart.not_in_cart' | translate }}
                    </span>
                  </ng-template>
                </div>
                <button
                  pButton
                  type="button"
                  [label]="('common.add' | translate) + ' (' + getProductQuantity(product.id) + ')'"
                  icon="pi pi-shopping-cart"
                  class="p-button-primary text-sm"
                  style="min-width: 100px; width: 35%; height: 2.25rem; padding: 0 1rem;"
                  [disabled]="!product.stock_quantity || product.stock_quantity === 0 || getProductQuantity(product.id) === 0 || getProductQuantity(product.id) > product.stock_quantity"
                  (click)="quickAddToCart(product)">
                </button>
              </div>
            </ng-container>
            
            <ng-template #outOfStockButton>
              <button
                pButton
                [label]="'products.stock.out_of_stock' | translate"
                icon="pi pi-times"
                [disabled]="true"
                class="w-full p-button-secondary p-button-sm">
              </button>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>