<!-- Product List with Fixed Sidebar Layout -->
<div class="flex flex-column border-3" style="height: calc(100vh - 4rem);">
  <p-toast></p-toast>
  
  <!-- Main Container -->
  <div class="flex-grow-1 flex overflow-hidden">
    <!-- Fixed Sidebar Filter (Desktop) -->
    <aside class="hidden lg:block surface-ground border-right-1 surface-border" style="width: 350px; flex-shrink: 0;">
      <app-product-filters
        [categories]="categories()"
        [selectedCategories]="selectedCategories()"
        (categoriesChange)="onCategoriesChange($event)"
        (filtersApplied)="applyFilters()"
        class="h-full block"
      ></app-product-filters>
    </aside>
    
    <!-- Main Content Area -->
    <main class="flex-grow-1 flex flex-column overflow-hidden surface-ground">
      <!-- Fixed Top Toolbar -->
      <app-product-toolbar
        [(searchQuery)]="searchQuery"
        [(sortBy)]="selectedSort"
        [(viewMode)]="layout"
        [filterCount]="activeFilterCount()"
        (search)="onSearch()"
        (mobileFiltersToggle)="toggleMobileFilters()"
        (filtersCleared)="clearFilters()"
      ></app-product-toolbar>
      
      <!-- Scrollable Products Area -->
      <div class="flex-grow-1 overflow-y-auto p-3 custom-scrollbar">
        @if (loading()) {
          <app-loading-state></app-loading-state>
        } @else if (products().length === 0) {
          <app-empty-state
            icon="pi-search"
            [title]="'products.empty.title' | translate"
            [description]="hasActiveFilters() ? ('products.empty.filter_message' | translate) : ('products.empty.subtitle' | translate)"
            [actionLabel]="hasActiveFilters() ? ('products.empty.clear_filters' | translate) : ''"
            [action]="clearFilters.bind(this)">
          </app-empty-state>
        } @else {
          <!-- Grid View -->
          @if (layout() === 'grid') {
            <div class="grid">
              @for (product of products(); track product.id) {
                <div class="col-12 sm:col-6 md:col-4 lg:col-6 xl:col-4 xxl:col-3">
                  <app-product-card
                    [product]="product"
                    (addToCartEvent)="onAddToCart($event)"
                    class="block h-full"
                  ></app-product-card>
                </div>
              }
            </div>
          }
          
          <!-- List View -->
          @if (layout() === 'list') {
            <div class="flex flex-column gap-3">
              @for (product of products(); track product.id) {
                <div class="surface-card border-round-lg shadow-1 list-view-item transition-all transition-duration-300 hover:shadow-3">
                  <div class="grid m-0">
                    <!-- Image Column -->
                    <div class="col-12 md:col-3 p-0">
                      <a [routerLink]="['/products', product.id]" class="block relative overflow-hidden border-round-left-lg" style="height: 100%; min-height: 220px;">
                        <img 
                          [src]="product.image_url || 'assets/images/product-placeholder.jpg'"
                          [alt]="product.name"
                          class="w-full h-full"
                          style="object-fit: cover;"
                        >
                        @if (product.is_organic) {
                          <p-tag 
                            severity="success" 
                            [value]="'Organic' | translate"
                            icon="pi pi-leaf"
                            class="absolute top-1 left-1 shadow-2"
                          ></p-tag>
                        }
                      </a>
                    </div>
                    
                    <!-- Content Column -->
                    <div class="col-12 md:col-9 p-4">
                      <div class="flex flex-column h-full">
                        <!-- Header -->
                        <div class="flex justify-content-between align-items-start mb-2">
                          <div>
                            <h3 class="m-0 mb-1 text-xl font-semibold">
                              <a [routerLink]="['/products', product.id]" class="text-900 no-underline hover:text-primary transition-colors">
                                {{ product.name }}
                              </a>
                            </h3>
                            <p class="text-sm text-500 m-0">Fresh Produce</p>
                          </div>
                          
                          <!-- Stock badge -->
                          <div class="text-right">
                            @if (isOutOfStock(product)) {
                              <span class="text-red-500 font-medium text-sm">
                                <i class="pi pi-times-circle mr-1"></i>Out of Stock
                              </span>
                            } @else if (product.stock_quantity < 20) {
                              <span class="text-orange-500 font-medium text-sm">
                                <i class="pi pi-exclamation-circle mr-1"></i>{{ product.stock_quantity }} left
                              </span>
                            } @else {
                              <span class="text-green-500 font-medium text-sm">
                                <i class="pi pi-check-circle mr-1"></i>In Stock
                              </span>
                            }
                          </div>
                        </div>
                        
                        <!-- Description -->
                        <p class="text-600 mb-3 line-height-3">
                          {{ product.description || 'Fresh, high-quality produce delivered daily from local farms. Perfect for your healthy lifestyle.' }}
                        </p>
                        
                        <!-- Footer with Price and Actions -->
                        <div class="mt-auto">
                          <div class="flex flex-column sm:flex-row gap-3 align-items-center">
                            <!-- Price -->
                            <div>
                              <div class="text-3xl font-bold text-900">
                                {{ formatPrice(product.price) }}
                              </div>
                              <span class="text-sm text-600">per {{ getUnitDisplay(product.unit) }}</span>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex gap-2 align-items-center sm:ml-auto">
                              @if (!isOutOfStock(product)) {
                                <p-select
                                  [(ngModel)]="productQuantities[product.id]"
                                  [options]="getQuantityOptions(product)"
                                  optionLabel="label"
                                  optionValue="value"
                                  [placeholder]="'Qty' | translate"
                                  styleClass="w-7rem"
                                ></p-select>
                                <button
                                  pButton
                                  icon="pi pi-cart-plus"
                                  [label]="'Add to Cart' | translate"
                                  (click)="quickAddToCart(product)"
                                  class="font-semibold"
                                ></button>
                              } @else {
                                <button
                                  pButton
                                  [label]="'Out of Stock' | translate"
                                  icon="pi pi-times"
                                  [disabled]="true"
                                  class="p-button-secondary"
                                ></button>
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
    </main>
  </div>
  
  <!-- Mobile Filters Drawer -->
  <p-drawer 
    [(visible)]="showMobileFilters"
    position="left"
    [style]="{width: '85%', maxWidth: '320px'}"
    [modal]="true"
    [dismissible]="true"
    [showCloseIcon]="true"
    (visibleChange)="showMobileFilters.set($event)"
  >
    <ng-template pTemplate="header">
      <span class="font-bold text-xl">{{ 'products.filters.title' | translate }}</span>
    </ng-template>
    
    <app-product-filters
      [categories]="categories()"
      [selectedCategories]="selectedCategories()"
      (categoriesChange)="onCategoriesChange($event)"
      (filtersApplied)="applyMobileFilters()"
      class="h-full block"
    ></app-product-filters>
  </p-drawer>
</div>